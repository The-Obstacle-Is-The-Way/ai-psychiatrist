
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://the-obstacle-is-the-way.github.io/ai-psychiatrist/_archive/bugs/BUG-018_NO_REAL_OLLAMA_INTEGRATION_TESTS/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>BUG-018: No Real Ollama Integration Tests - AI Psychiatrist</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bug-018-no-real-ollama-integration-tests" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="AI Psychiatrist" class="md-header__button md-logo" aria-label="AI Psychiatrist" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AI Psychiatrist
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              BUG-018: No Real Ollama Integration Tests
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/The-Obstacle-Is-The-Way/ai-psychiatrist" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="AI Psychiatrist" class="md-nav__button md-logo" aria-label="AI Psychiatrist" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    AI Psychiatrist
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/The-Obstacle-Is-The-Way/ai-psychiatrist" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Psychiatrist Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
     research
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
     research
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../_research/hypotheses-explained/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hypotheses Explained: Current State vs Future Improvements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../_research/hypotheses-for-improvement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hypotheses for Improvement: First-Principles Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../_research/master-bug-audit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MASTER BUG AUDIT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/future-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Future Architecture: Agent Orchestration Options
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Clinical
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Clinical
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clinical/clinical-understanding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Clinical Understanding: How This System Works
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clinical/glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clinical/phq8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PHQ-8: Patient Health Questionnaire
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clinical/task-validity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Task Validity: What Can (and Cannot) Be Inferred from DAIC-WOZ Transcripts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Configs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Configs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configs/agent-sampling-registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent Sampling Parameter Registry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configs/configuration-philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configs/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Data
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data/artifact-namespace-registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Artifact Namespace Registry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data/daic-woz-preprocessing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DAIC-WOZ Transcript Preprocessing (Bias-Aware, Deterministic)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data/daic-woz-schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DAIC-WOZ Dataset Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data/data-splits-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Splits Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Developer
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Developer
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer/api-endpoints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer/dependency-registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dependency Registry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer/error-handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Handling and Fail-Fast Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer/exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exception Reference (Domain + Runtime)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing Conventions (Markers, Fixtures, and Test Doubles)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/model-registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Psychiatrist Model Registry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/model-wiring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Wiring: Current State
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Pipeline internals
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pipeline internals
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline-internals/evidence-extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evidence Extraction Mechanism: How It Actually Works
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline-internals/features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Feature Reference (Non-Archive Canonical)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Preflight checklist
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Preflight checklist
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../preflight-checklist/preflight-checklist-few-shot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Preflight Checklist: Few-Shot Reproduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../preflight-checklist/preflight-checklist-zero-shot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Preflight Checklist: Zero-Shot Run
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Rag
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rag
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../rag/artifact-generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG Artifact Generation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../rag/chunk-scoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chunk-Level Scoring (Spec 35) — Schema, Workflow, and Gotchas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../rag/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG Debugging (Audit Logs + Guardrails)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../rag/design-rationale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG Design Rationale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../rag/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG Overview: Embeddings and Few-Shot Retrieval
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../rag/runtime-features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG Runtime Features
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Results
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    Results
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../results/few-shot-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Why Few-Shot May Not Beat Zero-Shot: Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../results/reproduction-results/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Paper Reproduction Results (Current Status)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../results/run-history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Complete Run History &amp; Statistical Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../results/run-output-schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reproduction Run Output Schema (JSON + Registry)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Statistics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            
  
    Statistics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../statistics/coverage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coverage Explained: What It Is and Why It Matters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../statistics/metrics-and-evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metrics and Evaluation (Exact Definitions + Output Schema)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../statistics/statistical-methodology-aurc-augrc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Statistical Methodology: AURC/AUGRC for Selective Prediction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#executive-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Executive Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evidence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Evidence
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#impact" class="md-nav__link">
    <span class="md-ellipsis">
      
        Impact
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scope-disposition" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scope &amp; Disposition
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommended-fix-ironclad-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommended Fix (Ironclad Plan)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Recommended Fix (Ironclad Plan)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-0-test-isolation-vs-real-integration-stop-the-testing-trap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 0: Test Isolation vs Real Integration (Stop the “TESTING” Trap)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-1-real-ollama-smoke-tests-local-optin" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 1: Real Ollama Smoke Tests (Local, Opt‑In)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-vertical-slice-tests-real-models-minimal-assertions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Vertical Slice Tests (Real Models, Minimal Assertions)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-full-pipeline-e2e-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: Full Pipeline E2E (Server)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-paper-fidelity-checkpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 4: Paper Fidelity Checkpoint
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files-involved" class="md-nav__link">
    <span class="md-ellipsis">
      
        Files Involved
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#blocking-status" class="md-nav__link">
    <span class="md-ellipsis">
      
        Blocking Status
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-run-local" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to Run (Local)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proposed-test-inventory-what-to-implement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Proposed Test Inventory (What to Implement)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#definition-of-done" class="md-nav__link">
    <span class="md-ellipsis">
      
        Definition of Done
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resolution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Resolution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#additional-fix-discovered-during-real-runs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional Fix (Discovered During Real Runs)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verification-local" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verification (Local)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/The-Obstacle-Is-The-Way/ai-psychiatrist/edit/main/docs/_archive/bugs/BUG-018_NO_REAL_OLLAMA_INTEGRATION_TESTS.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/The-Obstacle-Is-The-Way/ai-psychiatrist/raw/main/docs/_archive/bugs/BUG-018_NO_REAL_OLLAMA_INTEGRATION_TESTS.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="bug-018-no-real-ollama-integration-tests">BUG-018: No Real Ollama Integration Tests</h1>
<p><strong>Severity</strong>: HIGH (P1)
<strong>Status</strong>: RESOLVED
<strong>Date Identified</strong>: 2025-12-19
<strong>Date Resolved</strong>: 2025-12-21
<strong>Spec Reference</strong>: <code>docs/specs/09.5_INTEGRATION_CHECKPOINT_QUANTITATIVE.md</code></p>
<hr />
<h2 id="executive-summary">Executive Summary</h2>
<p>All LLM-facing tests are mock-based (either <code>MockLLMClient</code> or <code>respx</code>-mocked HTTP), and <strong>no automated test hits a live Ollama server or runs the pipeline end-to-end with real models</strong>. This means:
- Prompts are never validated against real model behavior
- Parsing and repair logic is never exercised against real LLM output
- Embeddings are never generated via Ollama’s <code>/api/embeddings</code> in a test run
- The full pipeline has never been executed with real infrastructure</p>
<p>This violates our own testing philosophy (Spec 01) and the intent of the 09.5 integration checkpoint. The architecture may be correct, but we cannot claim operational readiness without real Ollama validation.</p>
<hr />
<h2 id="evidence">Evidence</h2>
<ul>
<li><code>tests/integration/test_qualitative_pipeline.py</code> and <code>tests/integration/test_dual_path_pipeline.py</code> use <code>MockLLMClient</code> and never touch real Ollama.</li>
<li><code>tests/unit/infrastructure/llm/test_ollama.py</code> explicitly mocks HTTP calls using <code>respx</code> (no live server).</li>
<li>There is no test in <code>tests/</code> that invokes <code>OllamaClient</code> against a real host or calls <code>server.py</code> endpoints with a live model.</li>
<li>Spec 01 explicitly requires E2E tests with <strong>real</strong> Ollama, and Spec 09.5 calls for integration validation before Meta-Review; current tests do not satisfy that requirement.</li>
</ul>
<hr />
<h2 id="impact">Impact</h2>
<ul>
<li><strong>False confidence</strong>: Mock-only tests can pass while real model outputs fail parsing.</li>
<li><strong>Hidden failures</strong>: JSON repair paths, retry logic, and timeouts are untested under real latency/error conditions.</li>
<li><strong>Paper fidelity risk</strong>: We cannot validate MAE or N/A rates without running the actual models.</li>
<li><strong>Deployment risk</strong>: The API may fail at first real request (prompt drift, response format drift, model availability).</li>
</ul>
<hr />
<h2 id="scope-disposition">Scope &amp; Disposition</h2>
<ul>
<li><strong>Code Path</strong>: All LLM-facing agent/service paths (qualitative, judge, quantitative, embeddings, pipeline).</li>
<li><strong>Fix Category</strong>: Integration/E2E testing gap.</li>
<li><strong>Recommended Action</strong>: Treat as a hard gate at Checkpoint 09.5 (before Spec 10/11), after embedding artifacts are available.</li>
</ul>
<hr />
<h2 id="recommended-fix-ironclad-plan">Recommended Fix (Ironclad Plan)</h2>
<h3 id="phase-0-test-isolation-vs-real-integration-stop-the-testing-trap">Phase 0: Test Isolation vs Real Integration (Stop the “TESTING” Trap)</h3>
<p>Our current <code>tests/conftest.py</code> sets <code>TESTING=1</code> and clears env vars to prevent
local <code>.env</code> bleed-through. This is correct for unit/integration tests, but it
also prevents any real-LLM validation from using <code>.env</code> and developer-provided
settings.</p>
<p><strong>Policy</strong>:
- Default test runs stay isolated (<code>TESTING=1</code>, <code>.env</code> ignored).
- Real Ollama tests are <strong>opt-in</strong> and run in a “real mode”:
  - <code>AI_PSYCHIATRIST_OLLAMA_TESTS=1</code>
  - <code>.env</code> is allowed (no forced <code>TESTING=1</code>)
  - env variables are not cleared</p>
<p>This ensures our unit tests remain deterministic while making real integration
possible without rewriting config logic.</p>
<h3 id="phase-1-real-ollama-smoke-tests-local-optin">Phase 1: Real Ollama Smoke Tests (Local, Opt‑In)</h3>
<p>Create real integration tests that <strong>only run when explicitly enabled</strong>:
- Use pytest markers: <code>@pytest.mark.ollama</code>, <code>@pytest.mark.e2e</code>, <code>@pytest.mark.slow</code>
- Skip by default unless <code>AI_PSYCHIATRIST_OLLAMA_TESTS=1</code> is set
- Fail fast (with actionable error) if Ollama is unreachable or required models are missing</p>
<p>Minimum smoke tests:
1. <code>OllamaClient.simple_chat</code> returns non-empty content with the configured model
2. <code>OllamaClient.simple_embed</code> returns correct dimension and L2-normalized vector</p>
<h3 id="phase-2-vertical-slice-tests-real-models-minimal-assertions">Phase 2: Vertical Slice Tests (Real Models, Minimal Assertions)</h3>
<p>Add one real test per agent with <strong>structure-based assertions</strong>, not exact outputs:
1. <strong>QualitativeAssessmentAgent</strong>
   - Parsed <code>QualitativeAssessment</code> has non-empty core sections:
     <code>overall</code>, <code>phq8_symptoms</code>, <code>social_factors</code>, <code>biological_factors</code>, <code>risk_factors</code>
   - <code>supporting_quotes</code> may be empty (do not require quotes; they depend on transcript)
2. <strong>JudgeAgent</strong>
   - Evaluation returns all 4 metrics with scores in [1, 5]
   - Score extraction succeeds on raw judge text (i.e., the response contains a parseable score)
3. <strong>QuantitativeAssessmentAgent</strong>
   - All 8 items present
   - Scores are in {0,1,2,3} or None
   - Evidence strings are non-empty or "No relevant evidence found"
   - At least one score is numeric (guards against “total fallback skeleton” passing silently)
4. <strong>EmbeddingService</strong>
   - Embedding dimension matches config (4096)
   - L2 norm ≈ 1.0
   - Retrieval returns &lt;= top_k matches</p>
<h3 id="phase-3-full-pipeline-e2e-server">Phase 3: Full Pipeline E2E (Server)</h3>
<p>Add a real E2E test (preferred) and a runner script (nice-to-have):
1. Instantiate the FastAPI <code>app</code> from <code>server.py</code> via ASGI transport (no subprocess server needed)
2. Call <code>/health</code>
3. Call <code>/full_pipeline</code> using <code>transcript_text</code> (avoids requiring licensed DAIC-WOZ data)
4. Validate response shape:
   - <code>qualitative</code>, <code>quantitative</code>, <code>evaluation</code>, <code>meta_review</code> are present
   - PHQ-8 item keys exist and scores are valid or null
   - Meta-review severity is clamped to [0, 4]
5. Assert no unhandled exceptions and response fields conform to domain constraints</p>
<h3 id="phase-4-paper-fidelity-checkpoint">Phase 4: Paper Fidelity Checkpoint</h3>
<p>Run the paper’s quantitative metrics <strong>once</strong> on a small sample:
- Generate embeddings artifact (Spec 08 requirement)
- Measure MAE/N/A rate on a small subset of DAIC-WOZ (licensed data)
- Confirm outputs fall within the acceptable paper range</p>
<hr />
<h2 id="files-involved">Files Involved</h2>
<ul>
<li><code>tests/e2e/</code> (new real Ollama tests)</li>
<li><code>scripts/</code> (optional E2E runner for manual use)</li>
<li><code>tests/conftest.py</code> (enable real-mode opt-in without breaking isolated tests)</li>
<li><code>pyproject.toml</code> (pytest markers: <code>ollama</code>, <code>e2e</code>, <code>slow</code>)</li>
<li><code>docs/specs/09.5_INTEGRATION_CHECKPOINT_QUANTITATIVE.md</code> (add explicit real-LLM gate)</li>
</ul>
<hr />
<h2 id="blocking-status">Blocking Status</h2>
<p>This bug is a <strong>hard gate at Checkpoint 09.5</strong>. Do not proceed to Spec 10/11 until:
- At least one real Ollama test per agent passes locally
- The full pipeline E2E call succeeds on a real model</p>
<hr />
<h2 id="notes">Notes</h2>
<ul>
<li>Ollama can run locally (M1 Max is sufficient) but tests will be slow.</li>
<li>Use smaller models for smoke tests if needed; document model substitutions in <code>docs/models/MODEL_REGISTRY.md</code>.</li>
<li>Real PHQ-8 accuracy validation requires DAIC-WOZ ground truth and is not CI-safe.</li>
</ul>
<h3 id="how-to-run-local">How to Run (Local)</h3>
<ol>
<li>Start Ollama:</li>
<li><code>brew install ollama</code></li>
<li><code>brew services start ollama</code> (or <code>ollama serve</code>)</li>
<li>Pull models (choose what your machine can run; paper-optimal defaults shown):</li>
<li><code>ollama pull gemma3:27b</code></li>
<li><code>ollama pull alibayram/medgemma:27b</code></li>
<li><code>ollama pull qwen3-embedding:8b</code></li>
<li>Run the opt-in tests:</li>
<li><code>AI_PSYCHIATRIST_OLLAMA_TESTS=1 uv run pytest -m e2e --no-cov</code></li>
<li>Optional: <code>AI_PSYCHIATRIST_OLLAMA_TESTS=1 uv run pytest -m \"e2e and ollama\" --no-cov</code></li>
</ol>
<h3 id="proposed-test-inventory-what-to-implement">Proposed Test Inventory (What to Implement)</h3>
<p>These are the concrete, minimal tests that close this bug without flakiness:</p>
<ol>
<li><code>tests/e2e/test_ollama_smoke.py</code></li>
<li><code>test_ollama_ping_and_models_present</code></li>
<li><code>test_simple_chat_returns_expected_xml_answer_tag</code></li>
<li>
<p><code>test_simple_embed_dimension_and_l2_norm</code></p>
</li>
<li>
<p><code>tests/e2e/test_agents_real_ollama.py</code></p>
</li>
<li><code>test_qualitative_agent_assess_real_ollama</code></li>
<li><code>test_judge_agent_evaluate_real_ollama_scores_parseable</code></li>
<li><code>test_quantitative_agent_assess_real_ollama_has_some_numeric_scores</code></li>
<li>
<p>Optional: <code>test_embedding_service_build_reference_bundle_real_ollama</code> (uses a tiny temp pickle artifact)</p>
</li>
<li>
<p><code>tests/e2e/test_server_real_ollama.py</code></p>
</li>
<li><code>test_server_health_real_ollama</code></li>
<li><code>test_server_full_pipeline_transcript_text_zero_shot_real_ollama</code></li>
<li>Optional: <code>test_server_full_pipeline_few_shot_requires_embeddings_artifact</code> (skip if missing)</li>
</ol>
<h2 id="definition-of-done">Definition of Done</h2>
<ul>
<li>Real Ollama tests exist and are gated by explicit opt-in.</li>
<li>Each agent has at least one real integration test with structural assertions.</li>
<li>Full pipeline E2E test passes against a live Ollama server.</li>
<li>Documentation updated with exact commands to run locally.</li>
</ul>
<hr />
<h2 id="resolution">Resolution</h2>
<p>Implemented an opt-in real-Ollama E2E test suite that runs locally without CI flakiness:</p>
<ul>
<li>Added <code>tests/e2e/</code> with live Ollama tests (skip unless <code>AI_PSYCHIATRIST_OLLAMA_TESTS=1</code>).</li>
<li>Adjusted <code>tests/conftest.py</code> so “real mode” does not force <code>TESTING=1</code> and does not clear
  environment variables (allowing <code>.env</code> and model settings).</li>
<li>Added pytest marker <code>ollama</code> (strict markers are enabled).</li>
<li>Verified locally against a running Ollama daemon with paper-optimal models:</li>
<li><code>gemma3:27b</code></li>
<li><code>alibayram/medgemma:27b</code></li>
<li><code>qwen3-embedding:8b</code></li>
</ul>
<h3 id="additional-fix-discovered-during-real-runs">Additional Fix (Discovered During Real Runs)</h3>
<p>Real Ollama tests surfaced a configuration gap: <code>OLLAMA_TIMEOUT_SECONDS</code> was not
being applied to the per-request timeout on <code>OllamaClient.simple_chat()</code> and
<code>OllamaClient.simple_embed()</code> because those helpers were constructing
<code>ChatRequest</code> / <code>EmbeddingRequest</code> without passing the configured timeout,
falling back to protocol defaults (180s chat / 120s embeddings).</p>
<p>Fix: <code>OllamaClient.simple_chat()</code> and <code>OllamaClient.simple_embed()</code> now pass
<code>timeout_seconds=self._default_timeout</code>, ensuring <code>OLLAMA_TIMEOUT_SECONDS</code>
controls real request timeouts end-to-end (agents and server included).</p>
<h3 id="verification-local">Verification (Local)</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Smoke tests (chat + embeddings)</span>
<span class="nv">AI_PSYCHIATRIST_OLLAMA_TESTS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>tests/e2e/test_ollama_smoke.py<span class="w"> </span>-v<span class="w"> </span>--no-cov

<span class="c1"># Per-agent tests</span>
<span class="nv">AI_PSYCHIATRIST_OLLAMA_TESTS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>tests/e2e/test_agents_real_ollama.py<span class="w"> </span>-v<span class="w"> </span>--no-cov

<span class="c1"># Full pipeline E2E (FastAPI app via ASGI transport)</span>
<span class="nv">AI_PSYCHIATRIST_OLLAMA_TESTS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>tests/e2e/test_server_real_ollama.py<span class="w"> </span>-v<span class="w"> </span>--no-cov
</code></pre></div>
<p>Note: Paper-optimal 27B models can be slow on local hardware. If you see timeouts
(especially in the quantitative agent with MedGemma), run with a larger timeout:</p>
<div class="highlight"><pre><span></span><code><span class="nv">AI_PSYCHIATRIST_OLLAMA_TESTS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">OLLAMA_TIMEOUT_SECONDS</span><span class="o">=</span><span class="m">600</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;e2e and ollama&quot;</span><span class="w"> </span>--no-cov
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.code.copy", "content.action.edit", "content.action.view", "navigation.tracking", "navigation.sections", "navigation.footer", "navigation.instant"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>