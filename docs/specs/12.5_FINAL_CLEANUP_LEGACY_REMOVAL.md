# Spec 12.5: Final Cleanup & Legacy Code Removal

## Overview

**Checkpoint Location**: After Spec 12 (Observability), FINAL checkpoint

**Purpose**: Remove all legacy code, clean up cruft, verify the codebase contains only the new production implementation.

**Duration**: This is a **MANDATORY PAUSE** before declaring the refactor complete.

## Checkpoint Rationale

At this point, we have completed ALL feature specs:
- **Specs 01-04A**: Foundation & Infrastructure
- **Specs 05-07**: Qualitative Path
- **Specs 08-09**: Quantitative Path
- **Specs 10-11**: Integration & API
- **Spec 12**: Observability (logging, metrics, tracing)

The new implementation is **functionally complete and instrumented**. Now we must:
1. **Remove all legacy code** that has been replaced
2. **Verify nothing breaks** when legacy is removed
3. **Clean up any remaining cruft**
4. **Document what remains and why**

## Legacy Code Inventory (To Remove)

Based on codebase exploration, the following must be removed:

### Priority 1: Legacy Agent Directory

| File | LOC | Replacement | Remove? |
|------|-----|-------------|---------|
| `/agents/__init__.py` | ~10 | N/A | YES |
| `/agents/interview_simulator.py` | ~50 | `src/.../services/transcript.py` | YES |
| `/agents/qualitative_assessor_f.py` | ~150 | `src/.../agents/qualitative.py` | YES |
| `/agents/qualitative_assessor_z.py` | ~150 | (config toggle) | YES |
| `/agents/qualitive_evaluator.py` | 175 | `src/.../agents/judge.py` | YES |
| `/agents/quantitative_assessor_f.py` | 783 | `src/.../agents/quantitative.py` | YES |
| `/agents/quantitative_assessor_z.py` | ~150 | (config toggle) | YES |
| `/agents/meta_reviewer.py` | ~100 | `src/.../agents/meta_review.py` | YES |
| `/agents/interview_evaluator.py` | ~50 | Non-paper (optional) | ARCHIVE |

**Total**: ~1,600 LOC to remove

### Priority 2: Legacy Server

| File | LOC | Replacement | Remove? |
|------|-----|-------------|---------|
| `/server.py` | 70 | `src/.../api/main.py` | YES |

### Priority 3: Legacy Assessment Scripts

| Directory | Files | LOC | Replacement | Remove? |
|-----------|-------|-----|-------------|---------|
| `/qualitative_assessment/` | 2 | ~1,100 | `src/.../agents/qualitative.py` + CLI | YES |
| `/quantitative_assessment/` | 2+ | ~1,500 | `src/.../agents/quantitative.py` + CLI | YES |
| `/meta_review/` | 1 | ~50 | `src/.../agents/meta_review.py` | YES |

**Total**: ~2,650 LOC to remove

### Priority 4: Legacy Notebooks (Archive Decision)

| File | Purpose | Decision |
|------|---------|----------|
| `/quantitative_assessment/basic_quantitative_analysis.ipynb` | Research analysis | ARCHIVE |
| `/quantitative_assessment/embedding_quantitative_analysis.ipynb` | Research analysis | ARCHIVE |
| `/visualization/qual_boxplot.ipynb` | Paper figure generation | ARCHIVE |
| `/visualization/quan_visualization.ipynb` | Paper figure generation | ARCHIVE |
| `/visualization/meta_review_heatmap.ipynb` | Paper figure generation | ARCHIVE |

**Recommendation**: Move to `/_archive/research_notebooks/` rather than delete.

### Priority 5: Miscellaneous Cruft

| Item | Location | Decision |
|------|----------|----------|
| Example Ollama script | `/assets/ollama_example.py` | REMOVE (replaced by tests) |
| Analysis outputs | `/analysis_output/` | ARCHIVE or add to `.gitignore` |
| Literature folder venv | `/_literature/.venv/` | Should already be gitignored |

## Removal Protocol

### Step 1: Pre-Removal Verification

Before removing anything:

```bash
# 1. Ensure no imports from legacy code
grep -r "from agents\." src/
grep -r "import agents" src/
grep -r "from server import" src/
grep -r "from qualitative_assessment" src/
grep -r "from quantitative_assessment" src/
grep -r "from meta_review" src/

# If ANY results: STOP. Fix imports first.

# 2. Ensure all tests pass
make check

# 3. Create safety branch
git checkout -b pre-cleanup-backup
git push origin pre-cleanup-backup
git checkout spec-12.5/final-cleanup
```

### Step 2: Remove Legacy Directories

```bash
# Remove legacy agent implementations
rm -rf agents/

# Remove legacy server
rm server.py

# Remove legacy assessment scripts
rm -rf qualitative_assessment/
rm -rf quantitative_assessment/
rm -rf meta_review/

# Remove orphaned example
rm assets/ollama_example.py
```

### Step 3: Archive Research Artifacts

```bash
# Create archive directory
mkdir -p _archive/research_notebooks

# Move visualization notebooks
mv visualization/*.ipynb _archive/research_notebooks/

# Move analysis outputs (if not gitignored)
mv analysis_output/ _archive/

# Remove empty visualization directory
rmdir visualization/
```

### Step 4: Post-Removal Verification

```bash
# 1. All tests must still pass
make check

# 2. CLI must still work
python -m ai_psychiatrist.cli --help
python -m ai_psychiatrist.cli assess --participant-id 300 --dry-run

# 3. API must still work
python -m ai_psychiatrist.cli serve &
curl http://localhost:8000/health
curl -X POST http://localhost:8000/assess -d '{"participant_id": 300}'

# 4. No broken imports
python -c "import ai_psychiatrist; print('OK')"
```

### Step 5: Update Documentation

After removal:

- [ ] Update README.md (remove references to legacy structure)
- [ ] Update any spec docs that reference legacy paths
- [ ] Update `.gitignore` if needed
- [ ] Update SLURM scripts to use new CLI

## SLURM Script Migration

### Current State

```bash
# /slurm/job_assess.sh (LEGACY)
conda activate aipsy
cd /data/users4/xli/ai-psychiatrist
python assets/ollama_example.py  # OLD
```

### Required State

```bash
# /slurm/job_assess.sh (NEW)
source /path/to/venv/bin/activate  # or: eval "$(uv venv activate)"
cd /data/users4/xli/ai-psychiatrist
python -m ai_psychiatrist.cli batch-assess --split test --output results/
```

**Verification**: SLURM job should run successfully with new CLI.

## Final Tree Structure

After cleanup, the repository should look like:

```text
ai-psychiatrist/
├── .github/                    # CI/CD configuration
├── _archive/                   # Archived research artifacts (optional)
│   └── research_notebooks/
├── _literature/                # Research papers (reference)
├── assets/                     # Static assets (overview.png, etc.)
│   └── overview.png
├── data/                       # DAIC-WOZ data (.gitignored)
│   ├── transcripts/
│   ├── embeddings/
│   └── *.csv
├── docs/
│   ├── bugs/                   # Bug documentation
│   └── specs/                  # Specifications (kept for reference)
├── scripts/
│   └── prepare_dataset.py      # Data preparation utility
├── slurm/
│   ├── job_ollama.sh           # Ollama server job (production)
│   └── job_assess.sh           # Assessment job (UPDATED)
├── src/
│   └── ai_psychiatrist/        # ALL PRODUCTION CODE
│       ├── __init__.py
│       ├── cli.py
│       ├── config.py
│       ├── agents/
│       ├── api/
│       ├── domain/
│       ├── infrastructure/
│       └── services/
├── tests/
│   ├── unit/
│   ├── integration/
│   ├── e2e/
│   └── fixtures/
├── .env.example
├── .gitignore
├── Makefile
├── pyproject.toml
├── uv.lock
└── README.md
```

**What's GONE:**
- `/agents/` (replaced by `src/ai_psychiatrist/agents/`)
- `/server.py` (replaced by `src/ai_psychiatrist/api/`)
- `/qualitative_assessment/` (replaced by CLI + agents)
- `/quantitative_assessment/` (replaced by CLI + agents)
- `/meta_review/` (replaced by CLI + agents)
- `/visualization/` (archived)
- `/assets/ollama_example.py` (no longer needed)

## Quality Gates

### Gate 1: No Legacy Imports

```bash
# Must return empty
grep -r "from agents" . --include="*.py" | grep -v "_archive" | grep -v ".venv"
grep -r "import agents" . --include="*.py" | grep -v "_archive" | grep -v ".venv"
```

### Gate 2: All Tests Pass

```bash
make check  # lint + typecheck + test
```

### Gate 3: Full Pipeline Works

```bash
# CLI assessment
python -m ai_psychiatrist.cli assess --participant-id 300

# API assessment
python -m ai_psychiatrist.cli serve &
curl -X POST http://localhost:8000/assess -d '{"participant_id": 300}'
```

### Gate 4: Documentation Updated

- [ ] README reflects new structure
- [ ] No broken links to removed files
- [ ] SLURM scripts use new CLI

### Gate 5: Git History Clean

```bash
# Verify removal is clean
git status  # Should show deleted files

# Commit removal
git add -A
git commit -m "chore(cleanup): remove legacy code after refactor

BREAKING CHANGE: Legacy agent implementations removed.
Use src/ai_psychiatrist/ for all functionality.

Removed:
- /agents/ (1,600 LOC)
- /server.py (70 LOC)
- /qualitative_assessment/ (1,100 LOC)
- /quantitative_assessment/ (1,500 LOC)
- /meta_review/ (50 LOC)

Archived:
- Research notebooks → /_archive/research_notebooks/

See: docs/specs/12.5_FINAL_CLEANUP_LEGACY_REMOVAL.md"
```

## Post-Cleanup Validation

### LOC Comparison

| Metric | Before Cleanup | After Cleanup | Delta |
|--------|---------------|---------------|-------|
| Total Python LOC | ~8,000 | ~4,000 | -50% |
| Production code (`src/`) | ~2,000 | ~2,000 | 0% |
| Test code (`tests/`) | ~2,000 | ~2,000 | 0% |
| Legacy code | ~4,000 | 0 | -100% |

### Complexity Comparison

| Metric | Before | After |
|--------|--------|-------|
| Directories with Python | 10+ | 3 (`src/`, `tests/`, `scripts/`) |
| Entry points | 3+ | 1 (`ai_psychiatrist.cli`) |
| Config locations | 5+ | 1 (`config.py` + env) |

## Exit Criteria

**This checkpoint is COMPLETE when:**

1. [ ] All legacy code removed (or explicitly archived)
2. [ ] All tests pass after removal
3. [ ] CLI works with new structure
4. [ ] API works with new structure
5. [ ] SLURM scripts updated
6. [ ] README updated
7. [ ] Git history has clean removal commit
8. [ ] Senior review approved
9. [ ] Final LOC count documented

## Celebration Criteria

When this checkpoint passes:

- **The refactor is COMPLETE**
- Production code is clean, tested, and maintainable
- Legacy debt is paid off
- New features can be added without navigating cruft
- Paper methodology is faithfully reproduced

## Reference Commands

```bash
# Full cleanup sequence
git checkout -b spec-12.5/final-cleanup

# Verify no legacy imports
grep -r "from agents" . --include="*.py" | grep -v "_archive"

# Remove legacy
rm -rf agents/ server.py qualitative_assessment/ quantitative_assessment/ meta_review/

# Archive notebooks
mkdir -p _archive/research_notebooks
mv visualization/*.ipynb _archive/research_notebooks/

# Verify
make check
python -m ai_psychiatrist.cli assess --participant-id 300 --dry-run

# Commit
git add -A
git commit -m "chore(cleanup): remove legacy code after refactor"

# Final tree
find . -type f -name "*.py" | grep -v ".venv" | grep -v "__pycache__" | sort
```
