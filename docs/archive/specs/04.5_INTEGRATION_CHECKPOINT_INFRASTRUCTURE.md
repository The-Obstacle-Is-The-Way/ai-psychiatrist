# Spec 04.5: Pre-Infrastructure Integration Checkpoint

## Overview

**Checkpoint Location**: After Spec 04A (Data Organization), before Spec 05 (Transcript Service)

**Purpose**: Validate foundation and infrastructure layers are solid before building service layer.

**Duration**: This is a **MANDATORY PAUSE** for quality review.

## Checkpoint Rationale

At this point, we have completed:
- **Spec 01**: Project Bootstrap (uv, pyproject.toml, Makefile, CI/CD)
- **Spec 02**: Core Domain (entities, value objects, enums, exceptions)
- **Spec 03**: Configuration & Logging (Pydantic settings, structlog)
- **Spec 04**: LLM Infrastructure (Ollama client, protocols)
- **Spec 04A**: Data Organization (DAIC-WOZ preparation script)

This is the **last safe point** before we start building features that depend on this foundation. Any cracks in the foundation will propagate to all higher layers.

## Bug Hunt Protocol

### P0: Critical (Block all forward progress)

**Must check for:**

| Issue | Detection Method | Example |
|-------|-----------------|---------|
| Production code importing test fixtures | `grep -r "from tests" src/` | MockLLMClient in production |
| Secrets/credentials in code | `grep -rE "(password|secret|key)\s*=" --include="*.py"` | Hardcoded API keys |
| Missing critical dependencies | `uv pip check` | Broken imports |
| Failing CI on main branch | `gh run list --limit 5` | Red builds |
| Type errors in production code | `make typecheck` | mypy failures |

**Resolution**: Fix immediately before proceeding.

### P1: High (Fix before next checkpoint)

**Must check for:**

| Issue | Detection Method | Example |
|-------|-----------------|---------|
| `# type: ignore` in production code | `grep -r "type: ignore" src/` | Bypassing type safety |
| Bare `except:` clauses | `grep -r "except:" src/` | Swallowing all errors |
| `TODO/FIXME` markers | `grep -rE "(TODO|FIXME)" src/` | Incomplete implementation |
| Missing docstrings on public API | mypy + manual review | Undocumented functions |
| Hardcoded configuration values | `grep -rE "localhost\|127\.0\.0\.1\|11434" src/` | Config not in settings |

**Resolution**: File bugs, fix in current or next spec.

### P2: Medium (Track for later)

**Must check for:**

| Issue | Detection Method | Example |
|-------|-----------------|---------|
| Inconsistent naming conventions | Manual review | mix_of_naming_styles |
| Missing `__all__` exports | Module review | Implicit public API |
| Overly broad function signatures | Code review | `def process(data: Any)` |
| Code duplication | Manual review | Similar patterns repeated |

**Resolution**: Document in bug tracker, address during polish phase.

### P3-P4: Low (Nice to have)

**Track for:**
- Documentation improvements
- Performance optimizations
- Developer experience enhancements

## Quality Gates

### Gate 1: CI Health

```bash
# All checks must pass
make check

# Specifically:
make lint       # Ruff linting
make typecheck  # mypy strict
make test       # pytest with coverage
```

**Acceptance**: Zero failures, zero warnings treated as errors.

### Gate 2: Test Coverage

```bash
# Check coverage report
pytest --cov=src/ai_psychiatrist --cov-report=term-missing

# Verify thresholds
# Current requirement: ≥80%
```

**Acceptance**: Coverage ≥ 80%, no critical paths uncovered.

### Gate 3: Dependency Health

```bash
# Check for security vulnerabilities
uv pip audit  # or pip-audit

# Check for outdated dependencies
uv pip list --outdated
```

**Acceptance**: No critical vulnerabilities, dependencies reasonably current.

### Gate 4: Configuration Validation

```bash
# Verify all settings have defaults or clear documentation
python -c "from ai_psychiatrist.config import get_settings; s = get_settings(); print(s)"

# Test with missing env vars
unset OLLAMA_HOST && python -c "from ai_psychiatrist.config import get_settings; get_settings()"
```

**Acceptance**: Graceful defaults, clear error messages for required vars.

## Technical Debt Inventory

At this checkpoint, we must document:

### Current Technical Debt

| Item | Location | Severity | Notes |
|------|----------|----------|-------|
| Legacy `/agents/` directory | `/agents/*.py` | P2 | ~1,313 LOC to replace |
| Legacy `/server.py` | `/server.py` | P2 | 70 LOC, imports legacy agents |
| Legacy assessment scripts | `/qualitative_assessment/`, `/quantitative_assessment/`, `/meta_review/` | P2 | ~2,500 LOC |
| Hardcoded SLURM nodes | `/slurm/job_assess.sh` | P3 | Needs config injection |
| Orphaned example script | `/assets/ollama_example.py` | P4 | 19 LOC, has TODOs |

### Acceptable Debt at This Checkpoint

- Legacy code directories (will be replaced by Specs 05-10)
- Stub modules in `src/ai_psychiatrist/agents/`, `/services/`, `/api/` (placeholders)
- Missing integration tests (added in later specs)

### Unacceptable Debt (Must Fix Now)

- Any mock in production path
- Any hardcoded secrets
- Any failing tests
- Any type errors in `src/`

## Review Checklist

### Code Quality

- [ ] `src/ai_psychiatrist/` has zero linting errors
- [ ] `src/ai_psychiatrist/` has zero type errors (mypy strict)
- [ ] All public functions have docstrings
- [ ] No `print()` statements (use structlog)
- [ ] No bare `except:` clauses
- [ ] No `# type: ignore` without justification comment

### Architecture

- [ ] Domain layer has no infrastructure imports
- [ ] Infrastructure layer depends only on domain and stdlib
- [ ] Config is centralized in `config.py`
- [ ] Protocols define clear contracts
- [ ] No circular imports

### Testing

- [ ] Unit tests cover domain entities
- [ ] Unit tests cover value objects
- [ ] Unit tests cover configuration
- [ ] LLM protocol tests use proper mocking (httpx level)
- [ ] No mock abuse (mocking business logic)

### Documentation

- [ ] README is current
- [ ] Specs 01-04A are accurate to implementation
- [ ] Bug docs are up to date
- [ ] `.env.example` exists with all variables

### Data Organization

- [ ] `scripts/prepare_dataset.py` runs successfully
- [ ] Data structure matches Spec 04A
- [ ] `.gitignore` excludes `data/` directory
- [ ] Split CSVs handle column name variants

## Bug Documentation Template

When bugs are found, document in `/docs/bugs/`:

```markdown
# BUG-XXX: [Brief Title]

## Severity
P0/P1/P2/P3/P4

## Description
[What is the bug?]

## Impact
[Why does it matter?]

## Location
[File(s) and line number(s)]

## Reproduction Steps
1. [Step 1]
2. [Step 2]

## Root Cause
[Why did this happen?]

## Fix
[How was it fixed?]

## Prevention
[How do we prevent this in the future?]

## Spec Reference
[Which spec does this relate to?]
```

## Exit Criteria

**This checkpoint is COMPLETE when:**

1. [ ] All P0 issues resolved
2. [ ] All P1 issues either resolved or documented with plan
3. [ ] P2+ issues documented in bug tracker
4. [ ] CI/CD pipeline green
5. [ ] Test coverage ≥ 80%
6. [ ] Senior review approved
7. [ ] Technical debt inventory is current

## Next Steps

After passing this checkpoint:
1. Proceed to **Spec 05: Transcript Service**
2. Begin vertical slice implementation
3. Next checkpoint: **Spec 07.5** (after qualitative path)

## Reference Commands

```bash
# Full quality check
make check

# Bug hunt commands
grep -r "from tests" src/                          # Mock in prod
grep -r "type: ignore" src/                        # Type bypasses
grep -rE "(TODO|FIXME)" src/                       # Incomplete work
grep -rE "(password|secret|key|token)\s*=" src/   # Secrets
grep -r "except:" src/                             # Bare excepts
grep -r "print(" src/                              # Debug prints

# Coverage deep dive
pytest --cov=src/ai_psychiatrist --cov-report=html
open htmlcov/index.html

# Dependency audit
uv pip audit
```
